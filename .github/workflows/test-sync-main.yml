name: auto sync main branch from llvm-project to llvm

on:
  schedule:
  - cron: 0,10,20,30,40,50 * * * *
jobs:
   check:
     runs-on: ubuntu-latest
     strategy:
       fail-fast: false

     steps:
     - uses: actions/checkout@v2
       with:
         path: src
     - name: Sync
       run: |
         cd $GITHUB_WORKSPACE/src
         branch="main"
         base_repo="git@github.com:hanzhan1/llvm.git"
         sync_repo="https://github.com/llvm/llvm-project"
         if [ ! -d ".git" ]; then
            rm -rf ./*
            rm -rf ./.*
            git clone --progress $base_repo
         fi
         if [ ! -z "$(git status --porcelain)" ]; then
            git status
            echo "$branch workspace dirty, abort"
            return 1
          fi
          git checkout $branch
          git remote prune origin
          git pull --ff --ff-only origin
          if [ $? -ne 0 ]; then
              echo "failed to pull from origin, abort"
              return 1
          fi
          git pull --ff --ff-only $sync_repo $branch
          if [ $? -ne 0 ]; then
              echo "failed to pull from $sync_repo $branch, abort"
              return 1
          fi
          if [ "equal" == "$(get_state origin/$branch $branch)" ] ; then
              echo "no change, skip"
          elif [ "ahead" == "$(get_state origin/$branch $branch)" ] ; then
              git push origin
          else
              echo "$branch branch invalid state"
              return 1
          fi

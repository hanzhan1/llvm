name: automatic sync main branch from llvm-project to llvm

on:
  schedule:
  - cron: '*/10 * * * *'
jobs:
  check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          path: src
      - name: Sync
        env:
          BRANCH: "main"
          SYNC_REPO: https://github.com/llvm/llvm-project
        run: |
          cd $GITHUB_WORKSPACE/src
          if [ ! -z "$(git status --porcelain)" ]; then
              git status
              echo "$BRANCH workspace dirty, abort"
              return 1
          fi
          echo "check whether main branch exists"
          branch_exist=`git ls-remote --heads origin main | wc -l`
          if [ $branch_exist -ne 0 ]; then
              echo "$BRANCH branch exists, ready to update $BRANCH branch"
              git checkout $BRANCH
              git pull --ff --ff-only $SYNC_REPO $BRANCH
              if [ $? -ne 0 ]; then
                  echo "failed to pull from $SYNC_REPO $BRANCH, abort"
                  return 1
              fi
              #git_status=`git rev-list --count --left-right origin/$BRANCH...$BRANCH`
              if [ "0	0" == "$(git rev-list --count --left-right origin/$BRANCH...$BRANCH)" ] ; then
                  echo "no change, skip"
              elif [ "0	"* == "$git rev-list --count --left-right origin/$BRANCH...$BRANCH" ] ; then
                  git push origin
              else
                  echo "$BRANCH branch invalid state"
                  return 1
              fi
          else
              echo "$BRANCH branch not exists, ready to checkout new branch $BRANCH"
              git remote add upstream $SYNC_REPO
              git fetch upstream
              git checkout -B $BRANCH upstream/$BRANCH
              git push origin
          fi
          echo "sync finished"
